define(
    ['jquery', 'underscore', 'backbone', 'crel', 'h5f'/*, 'vulnerabilityAPI'*/],
    function ($, _, Backbone, crel, h5f) {
        'use strict';
        var exports = {},
            tabNames = {
                '#main': {
                    name: 'MAIN',
                    keys: [
//                        {name: 'affected_product', title: 'Affected Product:'},
                        {name: 'supercedes', title: 'Supercedes:', supercedes: [
//                            {name: 'supercedes_bulletin_kb', title: 'Supercedes Bulletin KB:'},
//                            {name: 'supercedes_bulletin_id', title: 'Supercedes Bulletin ID:'}
                        ]},
//                        {name: 'component_impact', title: 'Component Impact:'},
//                        {name: 'affected_component', title: 'Affected Component:'},
//                        {name: 'reboot', title: 'Reboot:'},
//                        {name: 'component_severity', title: 'Component Severity:'},
                        {name: 'id', title: 'ID:'},
//                        {name: 'component_kb', title: 'Component KB:'}
                    ]
                },
                '#bulletin': {
                    name: 'BULLETIN',
                    keys: [
                        {name: 'bulletin_id', title: 'ID:'},
                        {name: 'bulletin_details', title: 'Description:'}
//                        {name: 'bulletin_kb', title: 'Bulletin KB'},
//                        {name: 'bulletin_impact', title: 'Bulletin Impact:'},
//                        {name: 'bulletin_title', title: 'Bulletin Title:'},
//                        {name: 'bulletin_severity', title: 'Bulletin Severity:'}
                    ]
                },
                '#cveId': {
                    name: 'CVEIDS',
                    keys: [{name: 'cve_ids', title: 'CVE IDs:'}]
                }
            };
        exports.name = 'vulnerabilityInfo';
        exports.models = {
            Main: Backbone.Model.extend({
                defaults: {
                    id: '',
                    defaultTab: '#main'
                }
            })
        };
        exports.views = {
            Main: Backbone.View.extend({
                tagName: 'div',
                className: ['hardwareInfo'].join(' '),
                initialize: function () {
                    if (_.isUndefined(this.model)) {
                        throw new Error('hardwareInfo view requires a hardwareInfo model');
                    }
                    var id = this.model.get('id'),
                        type = this.model.get('type'),
                        that = this;
                    this._currentTab = this.model.get('defaultTab');
                    this.data = new (Backbone.Model.extend({
                        baseUrl: '/api/v1/app/' + type + '/',
//                        baseUrl: 'api/v1/app/os/vulnerability',
                        url: function () {
                            return this.baseUrl + id;
//                            return this.baseUrl;
                        }
                    }))();
                    this.listenTo(this.data, 'sync', this.renderTabs);
                },
                events: {
                    'click li a[data-toggle=tab]'   : 'changeTab'
                },
                beforeRender: $.noop,
                onRender: $.noop,
                render: function () {
                    if (this.beforeRender !== $.noop) { this.beforeRender(); }

                    var $el = this.$el;

                    if (this.data.url) { this.data.fetch(); }
                    if ($el.children().length === 0) {
                        $el.html(this.layout());
                    }
                    if (this.onRender !== $.noop) { this.onRender(); }
                    return this;
                },
                layout: function () {
                    var fragment = document.createDocumentFragment();
                    fragment.appendChild(
                        crel('div', {class: 'tabbable tabs-left'},
                            crel('ul', {class: 'nav nav-tabs'}),
                            crel('div', {class: 'tab-content'})
                        )
                    );
                    return fragment;
                },
                renderTabs: function (model) {
                    if (model.get('http_status') !== 200) {
                        throw new Error('API was not able to fetch data');
                    }
                    console.log(model.get('data').vulnerability_id);
                    if(model.get('data').vulnerability_id !== '')
                    {
                        this.vulnerabilityModel = new (Backbone.Model.extend({
                            baseUrl: '/api/v1/vulnerability/' + type + '/',
//                        baseUrl: 'api/v1/app/os/vulnerability',
                            url: function () {
                                return this.baseUrl + id;
//                            return this.baseUrl;
                            }
                        }))();

                        var selected, $navTabs = this.$el.find('.nav-tabs'),
                            fragment = document.createDocumentFragment(),
                            that = this;
                        _.each(_.keys(tabNames), function (tabName) {
                            selected = (tabName === that._currentTab) ? 'active'  : '';
                            fragment.appendChild(
                                crel('li', {class: selected},
                                    crel('a', {href: tabName, 'data-toggle': 'tab'}, tabNames[tabName].name))
                            );
                            if (selected) {
                                that.renderTab(tabName);
                            }
                        });
                        $navTabs.empty().append(fragment);
                    }
                    else
                    {
                        this.$el.remove();
                    }
                    return this;
                },
                changeTab: function (event) {
                    event.preventDefault();
                    var href = $(event.currentTarget).attr('href');
                    this.renderTab(href);
                },
                renderTab: function (tab) {
                    var $content = this.$el.find('.tab-content'),
                        $dl = $(crel('dl', {class: 'inline'})),
                        data = this.data.get('data'),
                        keys = tabNames[tab].keys;
                    $content.empty();
                    if (keys.length) {
                        _.each(keys, function (object) {
                            var content = data[object.name];
                            if (_.isUndefined(content)) {
                                return false;
                            } else if (typeof content === 'string') {
                                $dl.append(
                                    crel('dt', object.title),
                                    crel('dd', data[object.name] || 'N/A'));
                            } else if (content.length) {
                                $dl.append(
                                    crel('dt', object.title)
                                );
                                var innerContent;
                                if(object.hasOwnProperty('supercedes'))
                                {
                                    innerContent = object.supercedes;
                                    _.each(innerContent, function (obj) {
                                        $dl.append(
                                            crel('dt', obj.title),
                                            crel('dd', content[0][obj.name] || 'N/A')
                                        );
                                    });
                                }
                                else
                                {
                                    _.each(content, function (cveId) {
                                        $dl.append(
                                            crel('dd', {class: 'cveId'}, crel('a', {href: '#'}, cveId + ',') || 'N/A')
                                        );
                                    });
                                }
                            } else {
                                $dl.append(
                                    crel('dt', object.title),
                                    crel('dd', 'No data to display')
                                );
                            }
                        });
                    }
                    $content.append($dl);
                }
            })
        };
        return exports;
    }
);
