upstream rvlistener {
    server 127.0.0.1:9020;
    server 127.0.0.1:9021;
    server 127.0.0.1:9022;
    server 127.0.0.1:9023;
    server 127.0.0.1:9024;
    server 127.0.0.1:9025;
    server 127.0.0.1:9026;
    server 127.0.0.1:9027;
    server 127.0.0.1:9028;
    server 127.0.0.1:9029;
}

upstream rvweb {
    server 127.0.0.1:9060;
}

server {
    listen         80;
    server_name    10.0.0.21 localhost;
    rewrite        ^ https://$server_name$request_uri? permanent;
}

server {
    listen                      443;
    server_name                 _;
    ssl                         on;
    ssl_certificate             /opt/TopPatch/tp/data/ssl/server.crt;
    ssl_certificate_key         /opt/TopPatch/tp/data/ssl/server.key;

    ssl_session_timeout         5m;

    ssl_protocols               SSLv3 TLSv1;
    ssl_ciphers                 ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
    ssl_prefer_server_ciphers   on;
    client_max_body_size	    1G;
    client_body_buffer_size     100m;

    location /nginx_status {
        stub_status on;
        access_log   off;
        allow 192.168.0.0/16;
        allow 127.0.0.1;
        deny all;
    }

    location /upload/package {
        upload_store /opt/TopPatch/var/packages/tmp/;
        upload_store_access user:rw group:rw all:rw;
        upload_set_form_field $upload_field_name.name "$upload_file_name";
        upload_set_form_field $upload_field_name.content_type "$upload_content_type";
        upload_set_form_field $upload_field_name.path "$upload_tmp_path";
        upload_aggregate_form_field "$upload_field_name.md5" "$upload_file_md5";
        upload_aggregate_form_field "$upload_field_name.size" "$upload_file_size";
        upload_pass @after_upload;
        upload_pass_form_field "^id$";
        upload_pass_form_field ".*";
        upload_cleanup 400 404 499 500-505;
    }
      
    location @after_upload {
        proxy_pass              https://rvweb;
    } 

    location ^~ /api/ {
        proxy_pass              https://rvweb;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_intercept_errors  off;
        proxy_redirect          http:// https://; 
    }

    location ~ /ra/websockify/(.*)/([0-9]+) {                                                                                                             
        proxy_pass              http://$1:$2/websockify;                           
        proxy_read_timeout      2592000;                                           
        proxy_http_version      1.1;                                               
        proxy_set_header        Upgrade $http_upgrade;                             
        proxy_set_header        Connection "upgrade";                               
    } 

    location ~ /ra/(.*)/([0-9]+)/(.*$) {
        proxy_pass              http://$1:$2/$3;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_intercept_errors  off;
        proxy_redirect          http:// https://; 
	#echo 			"im in the location";
    }

    location  ^~ /ws/ {
        proxy_pass              https://rvweb;
        proxy_read_timeout      604800; # 7 days
        proxy_http_version      1.1;
        proxy_set_header        Upgrade $http_upgrade;
        proxy_set_header        Connection "upgrade";
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        #proxy_send_timeout      300;
    }

    location ^~ /rvl/ {
        proxy_pass              https://rvlistener;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_intercept_errors  off;
        proxy_redirect          http:// https://;
    }

    location ~* \.(?:ico|css|js|gif|jpe?g|png)$ {
        root                    /opt/toppatch-ui;
        expires                 max;
        add_header              Pragma public;
        add_header              Cache-Control "public, must-revalidate, proxy-revalidate";
    }

    location ~ /var/packages {
        root                    /opt/TopPatch/var/packages;
        expires                 max;
        add_header              Pragma public;
        add_header              Cache-Control "public, must-revalidate, proxy-revalidate";
    }

    location  ^~ /# {
        proxy_pass              https://rvweb;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect          http:// https://;
    }

    location  / {
        proxy_pass              https://rvweb;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect          http:// https://;
    }

}